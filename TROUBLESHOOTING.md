# 增强版CUDA训练故障排除指南

## 问题：程序在"增强版训练日志将写入xxx"后卡住

### 原因分析
这个问题通常由以下几个原因导致：

1. **文件写入阻塞**：日志文件写入时发生I/O阻塞
2. **帕累托前沿计算死锁**：多目标优化中的帕累托前沿计算陷入无限循环
3. **设备不一致错误**：GPU和CPU张量混用导致的设备错误
4. **种群多样性计算耗时**：大种群的多样性计算消耗过多时间
5. **数据退火调度器卡死**：复杂的数据处理逻辑导致阻塞

### 解决方案

#### 方案1：使用调试配置（推荐）

在 `core/main_enhanced_cuda.py` 中，将配置修改为：

```python
# 选择配置 (取消注释想要使用的配置)
# ACTIVE_CONFIG = ENHANCED_TRAINING_CONFIG     # 默认增强配置
# ACTIVE_CONFIG = QUICK_TEST_CONFIG          # 快速测试
ACTIVE_CONFIG = DEBUG_CONFIG               # 🛠️ 调试配置 (解决卡死问题)
```

调试配置的特点：
- 禁用了增强监控系统
- 禁用了超体积计算
- 禁用了详细日志记录
- 禁用了种群多样性跟踪
- 简化了多目标优化（只关注主要目标）
- 减少了监控保存频率

#### 方案2：手动调整配置参数

如果需要保留某些增强功能，可以手动调整以下参数：

```python
ENHANCED_TRAINING_CONFIG = {
    # ... 其他配置 ...
    
    # 减少计算频率
    "monitoring_save_interval": 50,        # 增加监控保存间隔
    "pareto_front_size": 30,               # 减少帕累托前沿大小
    
    # 禁用耗时功能
    "enable_hypervolume": False,           # 禁用超体积计算
    "track_diversity": False,              # 禁用多样性跟踪
    "detailed_logging": False,             # 禁用详细日志
    
    # 简化目标权重
    "objective_weights": {
        "sharpe_ratio": 0.7,               # 主要关注夏普比率
        "max_drawdown": 0.3,               # 适度关注回撤
    },
}
```

#### 方案3：逐步启用功能

从最简单的配置开始，逐步启用功能：

1. 首先使用 `QUICK_TEST_CONFIG` 验证基础功能
2. 然后启用数据退火：`enable_data_annealing = True`
3. 再启用多目标优化：`enable_multi_objective = True`
4. 最后启用增强监控：`enable_enhanced_monitoring = True`

### 代码修复内容

已修复的问题：

1. **文件写入超时保护**：添加了5秒超时机制和线程保护
2. **设备一致性修复**：确保所有张量操作在同一设备上
3. **帕累托前沿计算优化**：
   - 添加了快速近似算法用于大种群
   - 限制了比较次数避免O(n²)复杂度
   - 增加了错误恢复机制
4. **监控频率优化**：大幅减少了种群多样性计算频率
5. **错误处理增强**：所有关键组件都添加了异常处理

### 性能优化建议

1. **种群大小**：对于调试，建议使用1000-2000的种群大小
2. **批次大小**：根据GPU内存调整，通常500-1000较为合适
3. **监控间隔**：增加到20-50代保存一次监控数据
4. **帕累托前沿**：减少到30-50个解

### 监控训练状态

训练过程中可以通过以下方式监控：

1. **控制台输出**：每10代显示一次进度信息
2. **简单日志**：即使主日志失败，也会写入 `.simple.log` 文件
3. **备份文件**：日志写入失败时会创建 `.jsonl.backup` 文件
4. **检查点**：每20-50代自动保存检查点

### 如果问题仍然存在

1. 检查GPU内存是否充足
2. 检查磁盘空间是否足够
3. 尝试减少种群大小和批次大小
4. 考虑使用CPU版本进行调试
5. 查看系统资源使用情况（内存、CPU）

### 联系支持

如果以上方案都无法解决问题，请提供：
- 具体的错误信息
- 系统配置（GPU型号、内存大小）
- 使用的配置参数
- 训练数据的大小和特征维度